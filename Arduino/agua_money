#include <SPI.h>
#include <Ethernet.h>

byte mac[] = { 0xDE, 0xAD, 0xBE, 0xEF, 0xFE, 0xED };
IPAddress ip(192,168,0,105); //Atribui o IP ao Arduino
char server[] = "192.168.0.102"; //Endereço do servidor local

EthernetClient client;

int Pulso; //variável para a quantidade de pulsos
int j; //variável para os segundos
double liters; //variável para somar a média
double vazao; //variável para armazenar o valor em L/min
double valormedia=0; //variável para tirar a média a cada 1 minuto
double money_agua; //variável para calcular o valor em R$ de água
double mil_L; //variável para transformação em 10 metros cubicos

void setup() {
  Serial.begin(9600);
  Ethernet.begin(mac, ip);
  pinMode(2, INPUT);
  attachInterrupt(0, incrpulso, RISING); //configura a porta digital 2, para interrupção
}

void loop() {
  for(j=0; j<=60; j++) {
    Pulso = 0; //começa do 0 variável para contar os giros das pás internas, em segundos
    sei(); //liga interrupção
    delay (1000); //espera 1 segundo
    cli(); //desliga interrupção
    vazao = Pulso / 7.5; //converte para Litros/minuto
    
    Serial.print(vazao); //imprime na serial o valor da vazão
    Serial.print(" L/min - "); //imprime L/min
    Serial.print(j);
    Serial.println("s");
    
    liters = liters + vazao; //soma todas as vazões e guarda em uma 
    //variável para tirar a média posteriormente
    
    Serial.print("A soma parcial é ");
    Serial.print(liters);
    Serial.println(" L");
    
    vazao = 0;
  }
  
  liters = liters/60; //Tira a valormedia dividindo por 60
  mil_L = liters/1000;
  money_agua = mil_L * 2,415;
  Serial.print("\n Media por minuto = "); //imprime a frase valormedia por minuto =
  Serial.print(liters); //imprime o valor da valormedia
  Serial.println(" L/min - "); //Imprime L/min
  Serial.flush();

  
 
  //realiza a conexão e envia os dados para o servidor. É importante perceber que esses
  //códigos só são executados ao final do for anterior, ou seja, a cada 60 segundos
  if (client.connect(server, 80)) {
    client.print("GET /measurer/medida.php?");
    client.print("vazao=");
    client.print(liters);
    client.println(" HTTP/1.0"); 
    client.println("Host: 192.168.0.102"); //IP do servidor aqui.
    client.println("Encerrando conexão");
    client.println(); //pula linha
    client.stop();    //encerra a conexão
  }

  else {
    Serial.println("--> sem conexão\n");
    Serial.flush();
  }

  liters = 0; //torna variável valormedia = 0, para uma nova contagem
  j=0; //torna a variável 0, para uma nova contagem
  delay(10000); //dê ao servidor algum tempo para receber os dados e armazená-los.
}

void incrpulso ()
{ 
Pulso++;
}
